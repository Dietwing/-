# C4 Level 3 — Components: Application Services  
## (учёт ручных правок гейммастера)

Данный раздел дополняет и уточняет описание **Application Services** на уровне **C4 Level 3**, исходя из представленной диаграммы компонентов.  
В отличие от предыдущих пояснений, здесь сделан осознанный акцент на **прикладных сценариях (Use Cases)** и на принципиально важной особенности проекта — **возможности ручного вмешательства гейммастера в состояние игры**, не противоречащей автоматизированной логике Domain Core.

---

## 1. Роль Application Services в архитектуре

Контейнер **Application Services** выполняет функцию *оркестратора прикладных сценариев*.  
Он не содержит предметной логики как таковой, но:

- принимает пользовательские действия из UI;
- проверяет право выполнения действия (роль);
- определяет корректный сценарий выполнения;
- управляет границами операций;
- связывает UI с Domain Core, Persistence и вспомогательными контейнерами.

Таким образом, Application Services выступает **прослойкой управляемого доступа** между пользовательским интерфейсом и внутренними подсистемами приложения.

---

## 2. Use Case-компоненты как основа контейнера

Внутренняя структура контейнера построена вокруг набора **Use Case-компонентов**, каждый из которых соответствует осмысленному пользовательскому сценарию.

### 2.1 Создание и управление персонажами

**CreateSheet UC**  
Сценарий создания листа персонажа:
- используется игроком и мастером;
- инициирует сбор данных через UI;
- передаёт модель в Domain Core для расчётов и валидации.

**ImportCharacter UC**  
Сценарий импорта листа персонажа:
- доступен только мастеру;
- инициирует цепочку в контейнере Import/Export;
- по завершении сохраняет результат в библиотеку через Persistence.

**ManageLibrary UC**  
Сценарий управления библиотекой персонажей и NPC:
- загрузка, выбор, удаление, редактирование;
- работает исключительно с хранилищем;
- не вмешивается напрямую в боевую логику.

---

### 2.2 Ведение боя и управление состоянием

**RunCombat UC**  
Ключевой сценарий игрового процесса:
- управляет ходами, раундами и этапами боя;
- инициирует применение механик через Domain Core;
- фиксирует события боя и изменения состояния;
- сохраняет результаты через Persistence.

Этот сценарий отражает *нормальный, механически корректный* ход игры.

---

### 2.3 Ручная правка как осознанный сценарий

**ManualAdjustStats UC**  
Отдельный, явно выделенный сценарий **ручной правки состояния**, доступный только гейммастеру.

Он предназначен для ситуаций, когда:
- мастер сознательно отклоняется от формальных правил;
- необходимо срочно скорректировать HP, характеристики или эффекты;
- требуется “мастерское решение”, а не автоматический расчёт.

Ключевые особенности:
- сценарий вызывается из UI (обычно из экрана боя);
- изменения передаются в Domain Core как **override**, а не как результат механики;
- каждое такое действие фиксируется как отдельное событие;
- состояние обязательно сохраняется через Persistence.

Важно:  
ручная правка **не ломает** доменную модель, так как она:
- выполняется через отдельный Use Case;
- явно помечается как вмешательство мастера;
- не маскируется под обычный игровой расчёт.

---

## 3. Сопутствующие прикладные сценарии

**SessionLog UC**  
Работа с журналом сессии:
- фиксация событий;
- просмотр хронологии;
- используется мастером для анализа и контроля происходящего.

**RulesAccess UC**  
Сценарий доступа к правилам:
- поиск и открытие правил;
- обращение к контейнеру Rules Reference;
- не влияет на состояние игры напрямую.

**Notes UC**  
Работа с заметками мастера:
- создание, редактирование, удаление;
- используется в процессе игры и подготовки;
- данные хранятся через Persistence.

---

## 4. Инфраструктурные компоненты внутри контейнера

### 4.1 Role Guard — контроль прав

**Role Guard** — обязательный компонент, через который проходит любой запрос из UI.

Он:
- определяет роль пользователя (игрок / мастер);
- разрешает или запрещает выполнение конкретного Use Case;
- гарантирует, что чувствительные сценарии  
  (бой, импорт, ручные правки) доступны **только мастеру**.

Таким образом, контроль прав централизован и не размазан по сценариям.

---

### 4.2 Transaction Manager — границы операций

**Transaction Manager** отвечает за целостность операций:
- объединяет цепочки действий в одну логическую транзакцию;
- используется в сценариях, где меняется состояние системы:
  - бой,
  - ручные правки,
  - импорт,
  - управление библиотекой,
  - заметки.

Это обеспечивает:
- согласованность данных;
- возможность корректного отката;
- предсказуемое сохранение состояния.

---

## 5. Основные потоки взаимодействия

### 5.1 Бой по механике
1. UI → Role Guard — запрос действия.
2. Role Guard → RunCombat UC — проверка прав.
3. RunCombat UC → Transaction Manager.
4. RunCombat UC → Domain Core — расчёт шагов боя.
5. RunCombat UC → Persistence — сохранение состояния и событий.

---

### 5.2 Ручная правка мастером
1. UI → Role Guard — запрос ручного изменения.
2. Role Guard → ManualAdjustStats UC.
3. ManualAdjustStats UC → Transaction Manager.
4. ManualAdjustStats UC → Domain Core — override состояния.
5. ManualAdjustStats UC → Persistence — сохранение изменений и события override.

Этот поток принципиально отделён от обычного боя, что подчёркивает его осознанный характер.

---

## 6. Итоговая интерпретация

Представленная диаграмма показывает, что **Application Services**:

- структурирован вокруг *сценариев использования*, а не вокруг технических классов;
- чётко разделяет:
  - автоматизированные игровые механики,
  - и управляемое ручное вмешательство мастера;
- обеспечивает контроль ролей и транзакционную целостность;
- выступает архитектурным буфером между UI и Domain Core.

Особенно важно, что **ручные правки ГМ**:
- не являются “хаками”;
- не обходят архитектуру;
- формально описаны как отдельный прикладной сценарий.

Это делает систему одновременно:
- строгой с точки зрения модели,
- и гибкой с точки зрения реального ведения НРИ.

Данная диаграмма логически завершает раскрытие C4 Level 3 и подготавливает почву для дальнейших UML-диаграмм (последовательностей или состояний), если они потребуются в рамках дипломной работы.
